{"version":3,"file":"index.cjs","sources":["../src/index.ts"],"sourcesContent":["import Plugin from '@swup/plugin';\nimport { Location, getCurrentUrl } from 'swup';\nimport type { DelegateEvent, DelegateEventUnsubscribe, Handler } from 'swup';\n\ndeclare module 'swup' {\n\texport interface HookDefinitions {\n\t\t'form:submit': { el: HTMLFormElement; event: DelegatedSubmitEvent };\n\t\t'form:submit:newtab': { el: HTMLFormElement; event: DelegatedSubmitEvent };\n\t}\n}\n\ntype DelegatedSubmitEvent = DelegateEvent<SubmitEvent, HTMLFormElement>;\n\ntype Options = {\n\tformSelector: string;\n\tinlineFormSelector: string;\n\tstripEmptyParams: boolean;\n};\n\ntype FormInfo = {\n\turl: string;\n\thash: string;\n\tmethod: 'GET' | 'POST';\n\tdata: FormData;\n\tbody: URLSearchParams | FormData;\n\tencoding: string;\n};\n\nexport default class SwupFormsPlugin extends Plugin {\n\tname = 'SwupFormsPlugin';\n\n\trequires = { swup: '>=4' };\n\n\tdefaults: Options = {\n\t\tformSelector: 'form[data-swup-form]',\n\t\tinlineFormSelector: 'form[data-swup-inline-form]',\n\t\tstripEmptyParams: false\n\t};\n\toptions: Options;\n\n\t// Track pressed keys to detect form submissions to a new tab\n\tspecialKeys: { [key: string]: boolean } = {\n\t\tMeta: false,\n\t\tControl: false,\n\t\tShift: false\n\t};\n\n\tformSubmitDelegate?: DelegateEventUnsubscribe;\n\n\tconstructor(options: Partial<Options> = {}) {\n\t\tsuper();\n\t\tthis.options = { ...this.defaults, ...options };\n\t}\n\n\tmount() {\n\t\tthis.swup.hooks.create('form:submit');\n\t\tthis.swup.hooks.create('form:submit:newtab');\n\n\t\t// Register the submit handler. Using `capture:true` to be\n\t\t// able to set the form's target attribute on the fly.\n\t\tthis.formSubmitDelegate = this.swup.delegateEvent(\n\t\t\tthis.options.formSelector,\n\t\t\t'submit',\n\t\t\tthis.beforeFormSubmit.bind(this),\n\t\t\t{\n\t\t\t\tcapture: true\n\t\t\t}\n\t\t);\n\n\t\tthis.on('visit:start', this.handleInlineForms, { priority: 1 });\n\n\t\tdocument.addEventListener('keydown', this.onKeyDown);\n\t\tdocument.addEventListener('keyup', this.onKeyUp);\n\t\twindow.addEventListener('blur', this.onBlur);\n\t}\n\n\tunmount() {\n\t\tthis.formSubmitDelegate?.destroy();\n\n\t\tdocument.removeEventListener('keydown', this.onKeyDown);\n\t\tdocument.removeEventListener('keyup', this.onKeyUp);\n\t\twindow.removeEventListener('blur', this.onBlur);\n\t}\n\n\t/**\n\t * Handles form 'submit' events during the capture phase\n\t */\n\tbeforeFormSubmit(event: DelegatedSubmitEvent): void {\n\t\tconst swup = this.swup;\n\t\tconst { delegateTarget: form, submitter } = event;\n\t\tconst action = this.getFormAttr('action', form, submitter) || getCurrentUrl();\n\t\tconst opensInNewTabFromKeyPress = this.isSpecialKeyPressed();\n\t\tconst opensInNewTabFromTargetAttr =\n\t\t\tthis.getFormAttr('target', form, submitter) === '_blank';\n\t\tconst opensInNewTab = opensInNewTabFromKeyPress || opensInNewTabFromTargetAttr;\n\n\t\t// Create temporary visit object for form:submit:* hooks\n\t\tconst { url: to, hash } = Location.fromUrl(action);\n\t\t// @ts-expect-error: createVisit is currently private, need to make this semi-public somehow\n\t\tconst visit = swup.createVisit({ to, hash, el: form, event });\n\n\t\t/**\n\t\t * Allow ignoring this form submission via callback\n\t\t * No use in checking if it will open in a new tab anyway\n\t\t */\n\t\tif (!opensInNewTab && swup.shouldIgnoreVisit(action, { el: form, event })) {\n\t\t\treturn;\n\t\t}\n\n\t\t/**\n\t\t * Open the form in a new tab because of its target attribute\n\t\t */\n\t\tif (opensInNewTabFromTargetAttr) {\n\t\t\tswup.hooks.callSync('form:submit:newtab', visit, { el: form, event });\n\t\t\treturn;\n\t\t}\n\n\t\t/**\n\t\t * Open the form in a new tab if either Command (Mac), Control (Windows) or Shift is pressed.\n\t\t * Normalizes behavior across browsers.\n\t\t */\n\t\tif (opensInNewTabFromKeyPress) {\n\t\t\tswup.hooks.callSync('form:submit:newtab', visit, { el: form, event });\n\n\t\t\tform.dataset.swupOriginalFormTarget = form.getAttribute('target') || '';\n\t\t\tform.setAttribute('target', '_blank');\n\t\t\tform.addEventListener(\n\t\t\t\t'submit',\n\t\t\t\t() => requestAnimationFrame(() => this.restorePreviousFormTarget(form)),\n\t\t\t\t{ once: true }\n\t\t\t);\n\n\t\t\treturn;\n\t\t}\n\n\t\t/**\n\t\t * Trigger the form:submit hook.\n\t\t */\n\t\tswup.hooks.callSync('form:submit', visit, { el: form, event }, () => {\n\t\t\tthis.submitForm(event);\n\t\t});\n\t}\n\n\t/**\n\t * Restores the previous form target if available\n\t */\n\trestorePreviousFormTarget(form: HTMLFormElement): void {\n\t\tif (form.dataset.swupOriginalFormTarget) {\n\t\t\tform.setAttribute('target', form.dataset.swupOriginalFormTarget);\n\t\t} else {\n\t\t\tform.removeAttribute('target');\n\t\t}\n\t}\n\n\t/**\n\t * Submits a form through swup\n\t */\n\tsubmitForm(event: DelegatedSubmitEvent): void {\n\t\tconst el = event.delegateTarget;\n\t\tconst { url, hash, method, data, body } = this.getFormInfo(el, event);\n\t\tlet action = url;\n\t\tlet params: { method: 'GET' | 'POST'; body?: FormData | URLSearchParams } = { method };\n\n\t\tswitch (method) {\n\t\t\tcase 'POST':\n\t\t\t\tparams = { method, body };\n\t\t\t\tbreak;\n\t\t\tcase 'GET':\n\t\t\t\tthis.maybeStripEmptyParams(data);\n\t\t\t\taction = this.appendQueryParams(action, data);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tconsole.warn(`Unsupported form method: ${method}`);\n\t\t\t\treturn;\n\t\t}\n\n\t\tevent.preventDefault();\n\t\tthis.swup.cache.delete(action);\n\t\tthis.swup.navigate(action + hash, params, { el, event });\n\t}\n\n\t/**\n\t * Get information about where and how a form will submit\n\t */\n\tgetFormInfo(form: HTMLFormElement, { submitter }: SubmitEvent): FormInfo {\n\t\tconst method = (this.getFormAttr('method', form, submitter) || 'get').toUpperCase() as\n\t\t\t| 'GET'\n\t\t\t| 'POST';\n\t\tconst action = this.getFormAttr('action', form, submitter) || getCurrentUrl();\n\t\tconst { url, hash } = Location.fromUrl(action);\n\t\tconst encoding = (\n\t\t\tthis.getFormAttr('enctype', form, submitter) || 'application/x-www-form-urlencoded'\n\t\t).toLowerCase();\n\t\tconst multipart = encoding === 'multipart/form-data';\n\n\t\tconst data = new FormData(form);\n\t\tlet body: FormData | URLSearchParams;\n\t\tif (multipart) {\n\t\t\tbody = data;\n\t\t} else {\n\t\t\tbody = new URLSearchParams(data as unknown as Record<string, string>);\n\t\t}\n\n\t\treturn { url, hash, method, data, body, encoding };\n\t}\n\n\t/**\n\t * Get a form attribute either from the form, or the submitter element if present\n\t */\n\tgetFormAttr(\n\t\tattr: string,\n\t\tform: HTMLFormElement,\n\t\tsubmitter: HTMLElement | null = null\n\t): string | null {\n\t\treturn submitter?.getAttribute(`form${attr}`) ?? form.getAttribute(attr);\n\t}\n\n\t/**\n\t * Appends query parameters to a URL\n\t */\n\tappendQueryParams(url: string, data: FormData): string {\n\t\tconst path = url.split('?')[0];\n\t\tconst query = new URLSearchParams(data as unknown as Record<string, string>).toString();\n\t\treturn query ? `${path}?${query}` : path;\n\t}\n\n\t/**\n\t * Strip empty params from the FormData (by reference)\n\t * @see https://stackoverflow.com/a/64029534/586823\n\t */\n\tmaybeStripEmptyParams(data: FormData): void {\n\t\tif (!this.options.stripEmptyParams) return;\n\n\t\tfor (const [name, value] of Array.from(data.entries())) {\n\t\t\tif (value === '') data.delete(name);\n\t\t}\n\t}\n\n\t/**\n\t * Is either command or control key down at the moment\n\t */\n\tisSpecialKeyPressed(): boolean {\n\t\treturn Object.values(this.specialKeys).some((value) => value);\n\t}\n\n\t/**\n\t * Reset all entries in `specialKeys` to false\n\t */\n\tresetSpecialKeys() {\n\t\tfor (const key of Object.keys(this.specialKeys)) {\n\t\t\tthis.specialKeys[key] = false;\n\t\t}\n\t}\n\n\t/**\n\t * Run every time the window looses focus\n\t */\n\tonBlur = () => {\n\t\tthis.resetSpecialKeys();\n\t};\n\n\t/**\n\t * Adjust `specialKeys` on keyDown\n\t */\n\tonKeyDown = (event: KeyboardEvent): void => {\n\t\tif (this.specialKeys.hasOwnProperty(event.key)) {\n\t\t\tthis.specialKeys[event.key] = true;\n\t\t}\n\t};\n\n\t/**\n\t * Adjust `specialKeys` on keyUp\n\t */\n\tonKeyUp = (event: KeyboardEvent): void => {\n\t\tif (this.specialKeys.hasOwnProperty(event.key)) {\n\t\t\tthis.specialKeys[event.key] = false;\n\t\t}\n\t};\n\n\t/**\n\t * Handles visits triggered by forms matching [data-swup-inline-form]\n\t */\n\thandleInlineForms: Handler<'visit:start'> = (visit) => {\n\t\tconst { el } = visit.trigger;\n\t\tif (!el?.matches(this.options.inlineFormSelector)) return;\n\n\t\tif (!el.id) {\n\t\t\tconsole.error(`[@swup/forms-plugin] inline forms must have an id attribute:`, el);\n\t\t\treturn;\n\t\t}\n\n\t\t// Modify visit to only replace and animate the form's container\n\t\tconst selector = `#${el.id}`;\n\t\tvisit.containers = [selector];\n\t\tvisit.animation.scope = 'containers';\n\t\tvisit.animation.selector = selector;\n\t\tvisit.scroll.target = selector;\n\n\t\t// Modify visit to focus the form after the transition\n\t\t// @ts-expect-error: can't know if A11yPlugin is installed\n\t\tconst a11y = visit.a11y as { focus?: boolean | string };\n\t\tif (typeof a11y === 'object') {\n\t\t\ta11y.focus = selector;\n\t\t}\n\t};\n}\n"],"names":["Plugin","constructor","options","super","this","name","requires","swup","defaults","formSelector","inlineFormSelector","stripEmptyParams","specialKeys","Meta","Control","Shift","formSubmitDelegate","onBlur","resetSpecialKeys","onKeyDown","event","hasOwnProperty","key","onKeyUp","handleInlineForms","visit","el","trigger","matches","id","console","error","selector","containers","animation","scope","scroll","target","a11y","focus","mount","hooks","create","delegateEvent","beforeFormSubmit","bind","capture","on","priority","document","addEventListener","window","unmount","destroy","removeEventListener","delegateTarget","form","submitter","action","getFormAttr","getCurrentUrl","opensInNewTabFromKeyPress","isSpecialKeyPressed","opensInNewTabFromTargetAttr","opensInNewTab","url","to","hash","Location","fromUrl","createVisit","shouldIgnoreVisit","callSync","dataset","swupOriginalFormTarget","getAttribute","setAttribute","requestAnimationFrame","restorePreviousFormTarget","once","submitForm","removeAttribute","method","data","body","getFormInfo","params","maybeStripEmptyParams","appendQueryParams","warn","preventDefault","cache","delete","navigate","toUpperCase","encoding","toLowerCase","multipart","FormData","URLSearchParams","attr","path","split","query","toString","value","Array","from","entries","Object","values","some","keys"],"mappings":"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"}