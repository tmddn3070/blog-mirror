import t from"@swup/plugin";import{getCurrentUrl as e,Location as s}from"swup";class r extends t{constructor(t={}){super(),this.name="SwupFormsPlugin",this.requires={swup:">=4"},this.defaults={formSelector:"form[data-swup-form]",inlineFormSelector:"form[data-swup-inline-form]",stripEmptyParams:!1},this.options=void 0,this.specialKeys={Meta:!1,Control:!1,Shift:!1},this.formSubmitDelegate=void 0,this.onBlur=()=>{this.resetSpecialKeys()},this.onKeyDown=t=>{this.specialKeys.hasOwnProperty(t.key)&&(this.specialKeys[t.key]=!0)},this.onKeyUp=t=>{this.specialKeys.hasOwnProperty(t.key)&&(this.specialKeys[t.key]=!1)},this.handleInlineForms=t=>{const{el:e}=t.trigger;if(!e?.matches(this.options.inlineFormSelector))return;if(!e.id)return void console.error("[@swup/forms-plugin] inline forms must have an id attribute:",e);const s=`#${e.id}`;t.containers=[s],t.animation.scope="containers",t.animation.selector=s,t.scroll.target=s;const r=t.a11y;"object"==typeof r&&(r.focus=s)},this.options={...this.defaults,...t}}mount(){this.swup.hooks.create("form:submit"),this.swup.hooks.create("form:submit:newtab"),this.formSubmitDelegate=this.swup.delegateEvent(this.options.formSelector,"submit",this.beforeFormSubmit.bind(this),{capture:!0}),this.on("visit:start",this.handleInlineForms,{priority:1}),document.addEventListener("keydown",this.onKeyDown),document.addEventListener("keyup",this.onKeyUp),window.addEventListener("blur",this.onBlur)}unmount(){this.formSubmitDelegate?.destroy(),document.removeEventListener("keydown",this.onKeyDown),document.removeEventListener("keyup",this.onKeyUp),window.removeEventListener("blur",this.onBlur)}beforeFormSubmit(t){const r=this.swup,{delegateTarget:o,submitter:i}=t,a=this.getFormAttr("action",o,i)||e(),n=this.isSpecialKeyPressed(),m="_blank"===this.getFormAttr("target",o,i),u=n||m,{url:l,hash:h}=s.fromUrl(a),p=r.createVisit({to:l,hash:h,el:o,event:t});if(u||!r.shouldIgnoreVisit(a,{el:o,event:t})){if(!m)return n?(r.hooks.callSync("form:submit:newtab",p,{el:o,event:t}),o.dataset.swupOriginalFormTarget=o.getAttribute("target")||"",o.setAttribute("target","_blank"),void o.addEventListener("submit",()=>requestAnimationFrame(()=>this.restorePreviousFormTarget(o)),{once:!0})):void r.hooks.callSync("form:submit",p,{el:o,event:t},()=>{this.submitForm(t)});r.hooks.callSync("form:submit:newtab",p,{el:o,event:t})}}restorePreviousFormTarget(t){t.dataset.swupOriginalFormTarget?t.setAttribute("target",t.dataset.swupOriginalFormTarget):t.removeAttribute("target")}submitForm(t){const e=t.delegateTarget,{url:s,hash:r,method:o,data:i,body:a}=this.getFormInfo(e,t);let n=s,m={method:o};switch(o){case"POST":m={method:o,body:a};break;case"GET":this.maybeStripEmptyParams(i),n=this.appendQueryParams(n,i);break;default:return void console.warn(`Unsupported form method: ${o}`)}t.preventDefault(),this.swup.cache.delete(n),this.swup.navigate(n+r,m,{el:e,event:t})}getFormInfo(t,{submitter:r}){const o=(this.getFormAttr("method",t,r)||"get").toUpperCase(),i=this.getFormAttr("action",t,r)||e(),{url:a,hash:n}=s.fromUrl(i),m=(this.getFormAttr("enctype",t,r)||"application/x-www-form-urlencoded").toLowerCase(),u="multipart/form-data"===m,l=new FormData(t);let h;return h=u?l:new URLSearchParams(l),{url:a,hash:n,method:o,data:l,body:h,encoding:m}}getFormAttr(t,e,s=null){return s?.getAttribute(`form${t}`)??e.getAttribute(t)}appendQueryParams(t,e){const s=t.split("?")[0],r=new URLSearchParams(e).toString();return r?`${s}?${r}`:s}maybeStripEmptyParams(t){if(this.options.stripEmptyParams)for(const[e,s]of Array.from(t.entries()))""===s&&t.delete(e)}isSpecialKeyPressed(){return Object.values(this.specialKeys).some(t=>t)}resetSpecialKeys(){for(const t of Object.keys(this.specialKeys))this.specialKeys[t]=!1}}export{r as default};
//# sourceMappingURL=index.module.js.map
